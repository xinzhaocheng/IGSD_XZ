# ====================== 准备包 ======================
suppressPackageStartupMessages({
library(tidyverse)
library(scales)
library(grid)
})
# ====================== 读入 CSV 文件 ======================
file_path <- "D:/IGSD/figures/To_Xinzhao_figures/Europe_LNG_high_methane_producers_2060_by_producer.csv"
df <- read.csv(file_path, stringsAsFactors = FALSE)
# ====================== 固定情景顺序 ======================
scen_levels <- c("NetZero_default", "NetZero_core", "NetZero_CH4_CN", "NetZero_CH4_group")
df <- df %>%
mutate(Source = factor(Source, levels = scen_levels))
# ====================== 读入 CSV 文件 ======================
file_path <- "D:/IGSD/figures/To_Xinzhao_figures/IAMC/Europe_LNG_high_methane_producers_2060_by_producer.csv"
df <- read.csv(file_path, stringsAsFactors = FALSE)
names(df) <- c("Source", "producer", "value_2060")
# ====================== 固定情景顺序 ======================
scen_levels <- c("NetZero_default", "NetZero_core", "NetZero_CH4_CN", "NetZero_CH4_group")
df <- df %>%
mutate(Source = factor(Source, levels = scen_levels))
# ====================== 国家按默认情景排序 ======================
order_producer <- df %>%
filter(Source == "NetZero_default") %>%
arrange(desc(value_2060)) %>%
pull(producer)
df <- df %>%
mutate(producer = factor(producer, levels = order_producer))
# ====================== 配色 ======================
pal_scen <- c(
"NetZero_default"  = "#7f7f7f",
"NetZero_core"     = "#1f77b4",
"NetZero_CH4_CN"   = "#2ca02c",
"NetZero_CH4_group"= "#d62728"
)
# ====================== 图1：分组柱状图 ======================
p_bar <- ggplot(df, aes(x = producer, y = value_2060, fill = Source)) +
geom_col(position = position_dodge(width = 0.8), width = 0.75) +
scale_fill_manual(values = pal_scen, name = "Scenario") +
scale_y_continuous(labels = label_number(accuracy = 0.001)) +
coord_flip() +
labs(
title = "Value in 2060 by Producer across Scenarios",
x = NULL, y = "Value (2060)"
) +
theme_bw(base_size = 14) +
theme(legend.position = "top")
print(p_bar)
# ====================== 图2：差值图（相对默认） ======================
df_default <- df %>%
filter(Source == "NetZero_default") %>%
select(producer, value_default = value_2060)
df_diff <- df %>%
filter(Source != "NetZero_default") %>%
left_join(df_default, by = "producer") %>%
mutate(diff = value_2060 - value_default)
p_diff <- ggplot(df_diff, aes(x = producer, y = diff, color = Source)) +
geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.4) +
geom_segment(aes(xend = producer, y = 0, yend = diff),
linewidth = 0.6, alpha = 0.7) +
geom_point(size = 2) +
scale_color_manual(values = pal_scen, name = "Scenario") +
coord_flip() +
labs(
title = "Difference from NetZero_default (Scenario - Default), 2060",
x = NULL, y = "Δ Value"
) +
theme_bw(base_size = 14) +
theme(legend.position = "top")
print(p_diff)
# ====================== Packages ======================
suppressPackageStartupMessages({
library(tidyverse)
library(scales)
library(grid)
})
# ====================== Paths ======================
file_path <- "D:/IGSD/figures/To_Xinzhao_figures/IAMC/Europe_LNG_high_methane_producers_multiYear_by_producer.csv"
outdir    <- dirname(file_path)
# ====================== Read & normalize ======================
df_raw <- read.csv(file_path, stringsAsFactors = FALSE, check.names = FALSE)
names(df_raw) <- c("Source","producer","year","value")
# 只保留目标年份（如需更多，改这里）
yrs_keep    <- c("2025","2035","2060")
scen_levels <- c("NetZero_default","NetZero_core","NetZero_CH4_CN","NetZero_CH4_group")
df_raw <- df_raw %>%
mutate(
Source   = factor(Source, levels = scen_levels),
year     = factor(as.character(year), levels = yrs_keep),
producer = as.character(producer),
value    = suppressWarnings(as.numeric(value))
) %>%
filter(!is.na(year), !is.na(Source))
# ============ 设定 producer 顺序（按 default 的 2060 从大到小） ============
order_producer <- df_raw %>%
filter(Source == "NetZero_default", year == "2060") %>%
arrange(desc(value)) %>%
pull(producer)
order_producer <- c(order_producer, setdiff(unique(df_raw$producer), order_producer))
# 颜色：为所有 producer 生成一致的调色
prod_levels <- unique(order_producer)
pal_subsector <- setNames(hue_pal()(length(prod_levels)), prod_levels)
# ============================== Diff 图数据（套你的模版） ==============================
# 把 producer 当作“subsector”，用于填充和堆叠
df_long <- df_raw %>%
transmute(
scenario  = Source,
subsector = factor(producer, levels = order_producer),
year      = factor(as.character(year), levels = yrs_keep),
value     = value
)
# 汇总（无重复不会改变）
df_sum <- df_long %>%
group_by(year, scenario, subsector) %>%
summarise(value = sum(value, na.rm = TRUE), .groups = "drop")
# 默认情景基线
df_base <- df_sum %>%
filter(scenario == scen_levels[1]) %>%
select(year, subsector, base = value)
# 差值（按你之前确认：default − scenario；若要相反改为 value - base）
df_diff <- df_sum %>%
left_join(df_base, by = c("year","subsector")) %>%
mutate(base = coalesce(base, 0),
diff = base - value)
# 自定义布局（与模版一致）
yrs_plot <- levels(df_diff$year) %>% unique() %>% as.character()
eps      <- 0.06     # 同一年内相邻情景的横向偏移
year_gap <- 0.22     # 年份（这里是 2025/2035/2060）之间的间距
bar_w    <- 0.035    # 柱宽
centers <- numeric(length(yrs_plot))
centers[1] <- year_gap
if (length(yrs_plot) >= 2) for (i in 2:length(yrs_plot)) centers[i] <- centers[i-1] + year_gap
names(centers) <- yrs_plot
layout_df <- purrr::map_dfr(yrs_plot, function(y) {
k <- length(scen_levels)
offs <- ((seq_len(k) - (k + 1)/2) * eps)
tibble::tibble(
year = factor(y, levels = yrs_plot),
scenario = factor(scen_levels, levels = scen_levels),
x = centers[[y]] + offs
)
})
x_breaks    <- layout_df$x
# 隐藏 default 的主轴标签（与模版保持一致）
x_labels    <- ifelse(layout_df$scenario == scen_levels[1], "", as.character(layout_df$scenario))
sec_centers <- as.numeric(centers)
sec_labels  <- names(centers)
df_plot_diff <- df_diff %>%
mutate(
year     = factor(as.character(year), levels = yrs_plot),
scenario = factor(scenario, levels = scen_levels),
subsector = factor(as.character(subsector), levels = order_producer)
) %>%
left_join(layout_df, by = c("year","scenario"))
# ============================== Plot ==============================
p_diff <- ggplot(df_plot_diff, aes(x = x, y = diff, fill = subsector)) +
geom_col(width = bar_w, position = "stack") +
scale_fill_manual(values = pal_subsector, name = "Producer") +
scale_x_continuous(
breaks = x_breaks, labels = x_labels,
expand = expansion(mult = c(0.01, 0.02)),
sec.axis = dup_axis(name = NULL, breaks = sec_centers, labels = sec_labels)
) +
labs(
x = NULL,
y = "(Default − Scenario)",
title = "Europe LNG – High-Methane Producers"
) +
theme_bw(base_size = 12) +
theme(
legend.position    = "right",
legend.key.height  = unit(10, "pt"),
legend.key.width   = unit(14, "pt"),
axis.text.x        = element_text(angle = 45, hjust = 1, vjust = 1),
axis.text.x.top    = element_text(angle = 0,  hjust = 0.5, vjust = 0.5, margin = margin(b = 4)),
panel.grid.major.x = element_blank(),
panel.grid.minor.x = element_blank(),
plot.margin        = margin(t = 18, r = 34, b = 12, l = 10, unit = "pt")
) +
coord_cartesian(clip = "off")
print(p_diff)
